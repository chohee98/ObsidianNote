## ë°°ì—´ê³¼ ì£¼ì†Œ 
- #ë°°ì—´ ì€  ë™ì¼í•œ íƒ€ì…ì˜ ë°ì´í„° ë¬¶ìŒ
- ë°°ì—´ ìš”ì†Œ(element) : ë°°ì—´ì„ êµ¬ì„±í•˜ëŠ” ê° ê°’
- ì¸ë±ìŠ¤(index) : ë°°ì—´ì˜ ìœ„ì¹˜ë¥¼ ê°€ë¦¬í‚¤ëŠ” ìˆ«ì
- **ì£¼ì†Œ** `[ì‹œì‘ ì£¼ì†Œ + ì¸ë±ìŠ¤ * í¬ê¸°]`
- ë©”ëª¨ë¦¬ì—ì„œ aê°€ 12345ì—ì„œ ëë‚˜ì§€ ì•Šê³  ê·¸ ë’¤ì— ì—°ì´ì–´ì„œ bì˜ ì˜ì—­ì´ ì¡í˜€ ìˆëŠ” ê²ƒ í™•ì¸
- `mov rax, a`ì—ì„œ aëŠ” ë°ì´í„°ê°€ ì‹œì‘í•˜ëŠ” ì²« ë²ˆì§¸ ìœ„ì¹˜ì˜ ì£¼ì†Œ ê°’ (í”„ë¡œê·¸ë¨ ì‹œì‘í•  ë•Œ ë§ˆë‹¤ ë°”ë€” ìˆ˜ ìˆìŒ)
- `PRINT_HEX 1, [a]` aì˜ ë©”ëª¨ë¦¬ ê°’ì— ê°€ì„œ ê·¸ ê°’ì„ ë„ì§‘ì–´ ë‚¸ë‹¤ëŠ” ì˜ë¯¸
- `PRINT_HEX 2, [b+ecx]` ì§„í–‰ ì‹œ ì²« ë²ˆì§¸ ì£¼ì†Œ ê°’ë¶€í„° 2ê°œì˜ ë°”ì´íŠ¸ì˜ 0x01 0x00 ê°’ì´ ë¦¬í‹€ ì—”ë””ì•ˆì´ ì ìš©ëœ 0x001ì„ ë¶„ì„í•œ 1ì€ ì œëŒ€ë¡œ ì¶œë ¥ì´ ë˜ì§€ë§Œ ë‘ ë²ˆì§¸ ì£¼ì†Œ ê°’ë¶€í„° 2ë°”ì´íŠ¸ì— ë“¤ì–´ìˆëŠ” 0x00 0x01ì„ ë¶„ì„í•œ ê°’ì´  0x0100ê°€ ë˜ì–´ 100ì´ ì¶œë ¥
- ê²Œì„ì˜ ë§µì—ì„œ ê°ˆ ìˆ˜ ìˆëŠ” ì˜ì—­ì¸ì§€ ì•„ë‹Œì§€ë„ 2ì°¨ ë°°ì—´ë¡œ í‘œí˜„ ê°€ëŠ¥

```
CMAIN:
	mov rbp, rsp; for correct debugging
	; ë°°ì—´ì˜ ëª¨ë“  ë°ì´í„° ì¶œë ¥
	
	xor ecx, ecx
LABEL_PRINT_A:
	PRINT_HEX 1, [a+ecx]
	NEWLINE
	inc ecx
	cmp ecx, 5
	jne LABEL_PRINT_A
	
	xor ecx, ecx
LABEL_PRINT_B:
	;PRINT_HEX 2, [b+ecx]
	PRINT_HEX 2, [b+(ecx*2)]
	NEWLINE
	inc ecx
	cmp ecx, 5
	jne LABEL_PRINT_B

	xor rax, rax
	ret

section .data
	a db 0x01, 0x02, 0x03, 0x04, 0x05
	b times 5 dw 1 

section .bss
	num resb 10

```

![[ë°°ì—´1.png]]
![[ë°°ì—´2.png]]

***

## í•¨ìˆ˜ (Procedure, Subroutine)
- #í•¨ìˆ˜ ëŠ” ë°˜ë³µì ìœ¼ë¡œ ë“±ì¥í•˜ëŠ” ê¸°ëŠ¥ ê´€ë¦¬
- jmp (jump)ì™€ í•¨ìˆ˜ì˜ ì°¨ì´ëŠ” ret (return) ì˜ ì—¬ë¶€
- ê·¸ëŸ°ë° í•¨ìˆ˜ ì¸ìê°€ ë§ì•„ì§€ê±°ë‚˜ eax, ebxì— ì´ë¯¸ ì¤‘ìš”í•œ ê°’ì´ ìˆìœ¼ë©´ ì–´ë–»ê²Œ í•˜ì§€?
- ì¸ìê°€ í•„ìš”í•  ë•Œë§ˆë‹¤ .data .bss ê°™ì€ ë©”ëª¨ë¦¬ì— ì˜êµ¬ì ìœ¼ë¡œ í• ë‹¹í•˜ê¸°ëŠ” ë¶€ë‹´...
- ê·¸ë ‡ë‹¤ê³  ì˜êµ¬ì ìœ¼ë¡œ í• ë‹¹í•´ì„œ í•¨ìˆ˜ì—ì„œ ëŒë ¤ ì“°ê¸°ì—” í•¨ìˆ˜ ì•ˆì—ì„œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ë³€ìˆ˜ê°€ ê²¹ì¹˜ëŠ” ë¬¸ì œ ë°œìƒ...
- ê·¸ í•´ê²° ë°©ì•ˆì€ **ìŠ¤íƒ ë©”ëª¨ë¦¬ ì˜ì—­**!!
- ìŠ¤íƒì€ í•¨ìˆ˜ê°€ ì‚¬ìš©í•˜ëŠ” ì¼ì¢…ì˜ ë©”ëª¨ì¥ìœ¼ë¡œ ë§¤ê°œ ë³€ìˆ˜ë¥¼ ì „ë‹¬í•˜ê³  ëŒì•„ê°ˆ ì£¼ì†Œë¥¼ ê´€ë¦¬í•œë‹¤.

```
CMAIN:
	mov rbp, rsp; for correct debugging

	;call PRINT_MSG

	mov eax, 10
	mov ebx, 5
	call MAX
	PRINT_DEC 4, ecx
	NEWLINE

	xor rax, rax
	ret
  
PRINT_MSG:     ; ë¬¸ìì—´ì„ ì¶œë ¥í•˜ëŠ” print_msg í•¨ìˆ˜
	PRINT_STRING msg
	NEWLINE
	ret ;return

MAX:     ; ë‘ ê°’ì¤‘ í° ê°’ì„ ë°˜í™˜í•˜ëŠ” max í•¨ìˆ˜
	cmp eax, ebx
	jg L1
	mov ecx, ebx
	jmp L2
L1:
	mov ecx, eax
L2:
	ret

section .data
	msg db 'Hello World', 0x00

```

***

## ìŠ¤íƒ(stack) ğŸ˜¡

![[ìŠ¤íƒ.png|600]]
![[ìŠ¤íƒ í”„ë ˆì„.png]]
- #ìŠ¤íƒ ì€ ë†’ì€ ì£¼ì†Œ(high memory)ì—ì„œ ë‚®ì€ ì£¼ì†Œ(low memory) ë¡œ ì‚¬ìš©
- í•¨ìˆ˜ í˜¸ì¶œì´ ì™„ë£Œë˜ë©´ ì´ì „ step ìƒíƒœë¡œ ëŒì•„ê°
- ì¤‘ê°„ì¤‘ê°„ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹ ë°›ëŠ” ê²Œ ì•„ë‹ˆë¼ í”„ë¡œê·¸ë¨ ì‹¤í–‰ ì‹œ ë©”ëª¨ë¦¬ë¥¼ í¬ê²Œ í• ë‹¹í•˜ê³  ê±°ê¸°ì„œ ìš°ë¦¬ê°€ ìª¼ê°œì„œ ì“°ëŠ” ê°œë…

### #ë ˆì§€ìŠ¤í„° ëŠ” ë‹¤ì–‘í•œ ìš©ë„ë¡œ ì‚¬ìš©
-  a b c d ë²”ìš© ë ˆì§€ìŠ¤í„°
-  í¬ì¸í„° ë ˆì§€ìŠ¤í„° ğŸ˜ƒ
	- ip (Instruction Pointer) : ë‹¤ìŒ ìˆ˜í–‰ ëª…ë ¹ì–´ì˜ ìœ„ì¹˜
	- sp (Stack Pointer) : í˜„ì¬ ìŠ¤íƒ top ìœ„ì¹˜ (ì¼ì¢…ì˜ cursor)
	- bp (Base Pointer) : ìŠ¤íƒ ìƒëŒ€ ì£¼ì†Œ ê³„ì‚°ìš©

```
CMAIN:
	mov rbp, rsp; for correct debugging
	; rbp=ìŠ¤íƒ í¬ì¸í„°, rsp=ë² ì´ìŠ¤ í¬ì¸í„° (r=64bit)

	push 1
	push 2
	push 3

	pop rax
	pop rbx
	pop rcx

	xor rax, rax
	ret
```

- rip: ë‹¤ìŒ ì‹¤í–‰ë  ëª…ë ¹ì–´ ì£¼ì†Œ (Codeì˜ì—­ì„ ê°€ë¦¬í‚´)
- rsp ë ˆì§€ìŠ¤í„° ìœ„ì¹˜ë¥¼ ë³´ë©´ í˜„ì¬ ì—¬ê¸°ê¹Œì§€ ì‚¬ìš©í•˜ê³  ìˆë‹¤ëŠ” ê±¸ ê°€ë¦¬í‚´ (ì²« ë²ˆì§¸, ë‘ ë²ˆì§¸ ì‚¬ì§„)
- pop ì§„í–‰ ì‹œ rsp ë ˆì§€ìŠ¤í„°ê°€ ë‹¤ì‹œ 38ì„ ê°€ë¦¬í‚¤ê³  ìœ„ ì„¸ ê°œëŠ” ë‹¤ì‹œ ì•ˆ ì“°ëŠ” ë°ì´í„° ë²”ìœ„ê°€ ë¨ (ì„¸ ë²ˆì§¸ ì‚¬ì§„)

![[ìŠ¤íƒ push.png]]
![[shtack push register.png]]
![[ìŠ¤íƒ pop.png]]

### ìŠ¤íƒ ê·¸ë¦¼ìœ¼ë¡œ ë³´ê¸°
- `call MAX` ë¥¼ í•˜ë©´ rip ë ˆì§€ìŠ¤í„°ì— ë‚´ê°€ ì‹¤í–‰ ì¤‘ì¸ ìœ„ì¹˜ë¥¼ ì €ì¥í•˜ê¸° ë•Œë¬¸ì— ì´ ì£¼ì†Œë¥¼ ìŠ¤íƒì— ì„ì‹œ ì €ì¥
- sp ë ˆì§€ìŠ¤í„°ëŠ” ë‚´ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì–´ë”œ ì‚¬ìš©í•˜ê³  ìˆëŠëƒëŠ” ì»¤ì„œì˜ ê°œë…
- 1, 2, ê°’ì„ êº¼ë‚´ ì“°ê³  ì‹¶ì€ë° ì´ ì£¼ì†Œì— ì–´ë–»ê²Œ ì ‘ê·¼í•´ì•¼ í•˜ì§€?
- sp ë ˆì§€ìŠ¤í„°ê°€ í˜„ì¬ ìŠ¤íƒì˜ ì£¼ì†Œë‹ˆê¹Œ ì´ê±¸ 8 ì”© ë”í•´ì„œ ì˜¬ë¼ê°€ë©´ ë˜ì§€ ì•Šì„ê¹Œ? -> spëŠ” ê³ ì •ëœ ê°’ì´ ì•„ë‹ˆë¼ ì´ ê°’ìœ¼ë¡œ ìƒëŒ€ ì£¼ì†Œë¥¼ êµ¬í•˜ëŠ” ë°ëŠ” ì–´ë ¤ì›€ì´ ìˆìŒ
- ê·¸ë˜ì„œ bp ê°’ì„ ê³ ì • ì‹œì¼œ spê°€ ì•„ë¬´ë¦¬ ì™”ë‹¤ ê°”ë‹¤ í•˜ë”ë¼ë„ bp ì£¼ì†Œ ê°’ ê¸°ì¤€ìœ¼ë¡œ 16ì„ ë”í•˜ë©´ 2ë¼ëŠ” ì¸ìì—, 24ë¥¼ ë”í•´ì£¼ë©´ 1 ì¸ì ì¶”ì¶œ ê°€ëŠ¥
- push/pop rbpë¥¼ í•˜ëŠ” ì´ìœ ? í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ë‹¤ë¥¸ í•¨ìˆ˜ í˜¸ì¶œí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— bp ê°’ì„ ì–´ë”˜ê°€ì— ì„ì‹œ ì €ì¥ì„ í•´ì•¼ í•¨.
- ì¦‰, ê°ê°ì˜ í•¨ìˆ˜ë§ˆë‹¤ bp ê°’ì´ ìˆëŠ”ë° ìì‹ ì˜ ê³ ìœ  ì˜ì—­ì„ ì°ì–´ì£¼ê¸° ìœ„í•´ì„œ bp ë ˆì§€ìŠ¤í„° ì‚¬ìš©
- ë°‘ ì‚¬ì§„ì˜ bpë¥¼ ê´€ë¦¬í•˜ëŠ” ê³¼ì •ì„ "**stack frame**" #ìŠ¤íƒí”„ë ˆì„
- stack frameì—ëŠ” ì¸ì ì •ë³´ë„ ìˆì§€ë§Œ ëŒì•„ê°€ì•¼ ë  ê³³ì˜ ë¦¬í„´ ì£¼ì†Œë„ , ì´ì „ì— ì‚¬ìš©í•˜ë˜ ìŠ¤íƒì˜ ê³µê°„ ì •ë³´ë¥¼ ìœ„í•œ bp ê°’ë„ ì¡´ì¬ (ë©”ëª¨ì¥ ê°™ì€ ì¡´ì¬)
- ìŠ¤íƒì„ ì“°ê³  ë‚œ í›„ì— ê¹”ë”í•˜ê²Œ ì •ë¦¬ë¥¼ ì•ˆí•´ì£¼ë©´ crashê°€ ë‚  ìœ„í—˜ì´ ìˆìŒ
- ê·¸ë˜ì„œ í‘¸ì‰¬ë¥¼ í•œë²ˆ í•  ë•Œë§ˆë‹¤ 8ë°”ì´íŠ¸ ë§Œí¼ rsp ë¥¼ ì´ë™ ì‹œì¼œì•¼ í•˜ê¸° ë•Œë¬¸ì— ì–˜ë¥¼ ë‹¤ì‹œ ìœ„ìª½ìœ¼ë¡œ ë‘ ì¹¸ ë³µì› ì‹œì¼œì¤˜ì•¼ í•˜ê¸° ë•Œë¬¸ì— `add rsp, 16`
- main ë¬¸ì—ì„œ ì“°ëŠ” rax rbx ë¥¼ MAX í•¨ìˆ˜ì—ì„œë„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆëƒ? -> main ë¬¸ì—ì„œ  rax rbx ë¥¼ pushì™€ popì„ í†µí•´ ìŠ¤íƒì— ë„£ì–´ ë†“ìœ¼ë©´ ë¨

```
CMAIN:
    mov rbp, rsp; for correct debugging

    push rax
    push rbx
    push 1
    push 2
    call MAX
    PRINT_DEC 8, rax
    NEWLINE
    add rsp, 16
    pop rax
    pop rbx
    pop rcx

    pop rax
    pop rbx
    pop rcx

    xor rax, rax
    ret  

MAX:
    push rbp
    mov rbp, rsp
    mov rax, [rbp+16]
    mov rbx, [rbp+24]
    cmp rax, rbx
    jg L1
    mov rax, rbx
L1:
    pop rbp
    ret
```

| [Stack Memory] |
|:--------------:|
|       1        |
|       2        |
|   REP(ë‹¤ìŒ ì‹¤í–‰ ì£¼ì†Œ)    |
| ì´ì „ BPê°’               |
|                |


![[stackmemory1.png]]![[stackmemory2.png]]